// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace OrderSysManagement.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using OrderSysManagement;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using OrderSysManagement.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using AntDesign;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using OrderSysManagement.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using OrderSysManagement.Data;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using OrderSysManagement.Service;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "C:\Git\BlazorPeojects\OrderSysManagement\_Imports.razor"
using OrderSysManagement.Methods;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\Git\BlazorPeojects\OrderSysManagement\Pages\MenuTemplate.razor"
using System.Text;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/menuTemplate/{TransNum}")]
    public partial class MenuTemplate : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 75 "C:\Git\BlazorPeojects\OrderSysManagement\Pages\MenuTemplate.razor"
       
    [Parameter]
    public string TransNum { get; set; }
    private List<Article> ArticleButtonList = new List<Article>();
    private List<ArticleModel> FoodList = new List<ArticleModel>();
    private TransationModel Transaction { get; set; }
    private List<ArticleCategory> Categories = new List<ArticleCategory>();
    private decimal? TotalPriceOfTransation;
    private string Footer;
    int _pageSize = 5;
    public ResultMsg resultMsg =new ResultMsg();
    protected override async Task OnInitializedAsync()
    {
        Transaction = TransactionService.transactionList.FirstOrDefault(t => t.TableNum == TransNum);
        if (Transaction == null)
        {
            Transaction = new TransationModel();
            Transaction.TableNum = TransNum;
            Transaction.ArticleModels = new List<ArticleModel>();
            TransactionService.transactionList.Add(Transaction);
        }
        ArticleButtonList = await ArticleService.GetArticlesAsync();
        FoodList = ArticleButtonList.Select(a => new ArticleModel
        {
            Code = a.Code,
            Name = a.Description,
            AmountMet = a.AmountMet,
            Price = a.Price,
            ArticleCategoryId = a.ArticleCategoryId.ToString(),
            ArticleCategoryName = a.ArticleCategory.Description
        }).ToList();
        Categories = await ArticleCategoryService.GetCategoriesAsync();
        GetTotalPriceOfTransation();
    }

    public string radioValue = "主食";

    public void OrderFood(int foodCode)
    {
        var food = Transaction.ArticleModels.FirstOrDefault(a => a.Code == foodCode);
        if (food == null)
        {
            food = FoodList.First(a => a.Code == foodCode);
            food.Number = 0;
            if (food.Price < 0 && GetTotalPriceOfTransation() < food.AmountMet)
            {

                resultMsg.SetResult(new ActionResult
                {
                    Status = ActionStatus.Failed,
                    Msg = "金额不满足折扣条件：" + food.Name
                });
                return;
            }
            Transaction.ArticleModels.Add(food);
        }
        if (food.ArticleCategoryName == "百分比折扣")
        {
            food.Number = 1;
        }
        else
        {
            food.Number = food.Number + 1;
            food.TotalPrice = food.Number * food.Price;
        }
        GetTotalPriceOfTransation();
    }
    public void PrintBill()
    {
        StringBuilder sb = new StringBuilder();
        sb.Append("     餐饮管理系统  \n");
        //40
        sb.Append("****************************************\n");
        string a = ("商品名").PadRight(20, ' ') + ("价格").PadRight(20, ' ') + "\n";
        sb.Append(a);
        foreach (var f in Transaction.ArticleModels)
        {
            string text = f.Name.PadRight(20, ' ') + f.Price.ToString().PadRight(20, ' ') + "\n";
            sb.Append(text);
        }
        sb.Append("*************************************\n");
        PrintJob.Print(sb.ToString());
    }
    private void CheckOut()
    {
        Transaction.TransNum = TransactionService.GetMaxTransNum() + 1;
        TransactionService.InsertTransaction(Transaction);
        TransactionService.transactionList.Remove(Transaction);
        Transaction = new TransationModel();
        Transaction.ArticleModels = new List<ArticleModel>();
        Transaction.TableNum = TransNum;
        TransactionService.transactionList.Add(Transaction);
        GetTotalPriceOfTransation();
    }
    private void Return()
    {
        NavigationManager.NavigateTo("/tables");
    }
    private void Deduct(int? code)
    {
        var food = Transaction.ArticleModels.First(f => f.Code == code);
        food.Number = food.Number - 1;
        food.TotalPrice = food.Number * food.Price;
        if (food.Number == 0)
        {
            Transaction.ArticleModels.Remove(food);
        }
        GetTotalPriceOfTransation();
    }
    //private void Add(int? code)
    //{
    //    var food = Transaction.ArticleModels.First(f => f.Code == code);
    //    food.Number = food.Number + 1;
    //    food.TotalPrice = food.Number * food.Price;
    //    GetTotalPriceOfTransation();
    //}
    private decimal? GetTotalPriceOfTransation()
    {
        if (Transaction.ArticleModels.Any())
        {
            TotalPriceOfTransation = Transaction.ArticleModels.Where(f => f.ArticleCategoryName != "百分比折扣").Sum(f => f.TotalPrice);
            var percentDiscountArticle = Transaction.ArticleModels.FirstOrDefault(f => f.ArticleCategoryName == "百分比折扣");
            if (percentDiscountArticle != null)
            {
                percentDiscountArticle.TotalPrice =Math.Round(Convert.ToDecimal(TotalPriceOfTransation * percentDiscountArticle.Price),3);
                TotalPriceOfTransation += percentDiscountArticle.TotalPrice;
            }
            Footer = "总金额：" + Convert.ToString(TotalPriceOfTransation);
            return TotalPriceOfTransation;
        }
        else
        {
            Footer = null;
            return 0;
        }
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private PrintJobService PrintJob { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ArticleCategoryService ArticleCategoryService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private TransactionService TransactionService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ArticleService ArticleService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager NavigationManager { get; set; }
    }
}
#pragma warning restore 1591
